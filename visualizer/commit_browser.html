<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="/codeql/visualizer/basic.css" />
    <link rel="stylesheet" href="/codeql/visualizer/commit_viewer.css" />
  </head>
  <body>
    <div class="row absolute full-height full-width">
      <div class="col" id="sidebar">
        <div style="margin-bottom: 10px">
          CWE: <form style="display: inline-block"><input id="cwe-filter" name="cwe" placeholder="CWE" /><button action="submit">Submit</button></form>
        </div>
        <div class="divider"></div>
        <div id="projects-holder">
          <ul id="projects">

          </ul>
        </div>
      </div>
      <div class="col fill" id="main">
        <div>
          <strong>Github Username:</strong>
          <a id="github-username" href="" target="_blank"></a>
        </div>
        <div>
          <strong>Github Project:</strong>
          <a id="github-project-name" href="" target="_blank"></a>
        </div>
        <div>
          <strong>CVE ID:</strong>
          <span id="cve-id"></span>
          <span id="nvd-detail-link-outer" style="display: none">
            (<a id="nvd-detail-link" target="_blank" href="">NVD Detail</a>)
          </span>
        </div>
        <div>
          <strong>Commits Fixing This Vulnerability:</strong>
          <span id="commits"></span>
        </div>
        <div id="files">

        </div>
        <div id="temp"></div>
      </div>
    </div>
    <script>
      var codeql_advisory_cves_mapped_w_commits = [];

      function loadCodeQLAdvisoryCVEsMappedWCommits(data) {
        const searchParams = new URLSearchParams(window.location.search);
        if (searchParams.has("cwe")) {
          let cwe_id = searchParams.get("cwe");
          $("#cwe-filter").val(cwe_id);
          codeql_advisory_cves_mapped_w_commits = data.filter((row) => {
            if (!row["cwe"]) {
              return false;
            } else {
              return row["cwe"].split(";").indexOf(`CWE-${cwe_id}`) >= 0;
            }
          });
        } else {
          codeql_advisory_cves_mapped_w_commits = data;
        }

        for (let row_id in codeql_advisory_cves_mapped_w_commits) {
          let row = codeql_advisory_cves_mapped_w_commits[row_id];
          if (!row["commits"] || row["commits"] === "" || row["cwe"] === "" || row["cve"] === "") {
            continue;
          }
          let commits = row["commits"].split(";");
          let project = commits[0].split("/")[4];
          let cwe_ids = row["cwe"].split(";").map((id) => `<span class="cwe-id">${id}</span>`).join("");
          $("#projects").append(`
<li id="project-${row["cve"]}" onclick="clickProject('${row["cve"]}')">
  <span class="cve-id">${row["cve"]}</span>
  <span class="project">${project}</span>
  ${cwe_ids}
</li>`);
        }

        if (searchParams.has("cve")) {
          let cve_id = searchParams.get("cve");
          clickProject(cve_id);
        }
      }

      function clickProject(cve_id) {
        var currentUrl = window.location.href;
        var url = new URL(currentUrl);
        url.searchParams.set("cve", cve_id);
        window.history.pushState(null, document.title, url.href);

        $(`#project-${cve_id}`).addClass("active").siblings().removeClass("active");

        $("#cve-id").text(cve_id);
        let row = codeql_advisory_cves_mapped_w_commits.filter((row) => row["cve"] == cve_id)[0];

        let commits = row["commits"].split(";");
        $("#cve-id").text(row["cve"]);

        let github_username = commits[0].split("/")[3];
        $("#github-username").attr("href", `https://github.com/${github_username}`);
        $("#github-username").text(github_username);

        let github_project = commits[0].split("/")[4];
        $("#github-project-name").attr("href", `https://github.com/${github_username}/${github_project}`);
        $("#github-project-name").text(github_project);

        $("#nvd-detail-link-outer").attr("style", "");
        $("#nvd-detail-link").attr("href", `https://nvd.nist.gov/vuln/detail/${row["cve"]}`)

        $("#commits").html("");
        $("#files").html("");
        commits.forEach((commit_link) => {
          let commit_id = commit_link.split("/")[6];
          $("#commits").append(`<a class="commit" target="_blank" href="${commit_link}">${commit_id.substring(0, 12)}</a>`);

          let file_name = `${github_username}__${github_project}_${commit_id}.json`;
          $.ajax({
            url: `/codeql/commit_data/${file_name}`,
            type: "GET",
            dataType: "json",
            success: (json_content) => {
              json_content["files"].forEach((file_json) => {
                if (file_json["filename"].indexOf(".java") == file_json["filename"].length - 5) {
                  let patch = file_json["patch"]
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
                  let patch_lines = patch.split("\n").map((line) => {
                    if (line[0] == "-") {
                      return `<div class="line remove">${line}</div>`;
                    } else if (line[0] == "+") {
                      return `<div class="line add">${line}</div>`;
                    } else {
                      return `<div class="line">${line}</div>`;
                    }
                  });
                  let change_file_html = `
                    <div class="diff-file">
                      <div>
                        <a target="_blank" href="${json_content["html_url"]}">${json_content["sha"].substring(0, 12)}</a>
                        :
                        <a target="_blank" href="${file_json["blob_url"]}">${file_json["filename"]}</a>
                      </div>
                      <pre>${patch_lines.join("")}</pre>
                    </div>`;
                  $("#files").append(change_file_html);
                } else {
                  let change_file_html = `
                    <div class="diff-file">
                      <div>
                        <a target="_blank" href="${json_content["html_url"]}">${json_content["sha"].substring(0, 12)}</a>
                        :
                        <a target="_blank" href="${file_json["blob_url"]}">${file_json["filename"]}</a>
                      </div>
                    </div>`;
                  $("#files").append(change_file_html);
                }
              })
            }
          })
        })
      }

      $.ajax({
        url: "/codeql/codeql_advisory_cves_mapped_w_commits.csv",
        type: "GET",
        success: (csv_content) => {
          let parsed_result = Papa.parse(csv_content, { header: true });
          let data = parsed_result.data;
          loadCodeQLAdvisoryCVEsMappedWCommits(data);
        },
      })
    </script>
  </body>
</html>
