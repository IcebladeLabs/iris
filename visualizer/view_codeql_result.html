<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="/codeql/visualizer/basic.css" />
    <link rel="stylesheet" href="/codeql/visualizer/alert_viewer.css" />
  </head>
  <body>
    <div class="row absolute full-height full-width">
      <div class="col" id="sidebar">
        <div style="margin-bottom: 10px">
          CWE: <form style="display: inline-block"><input id="cwe-filter" name="cwe" placeholder="CWE" /><button action="submit">Submit</button></form>
        </div>
        <div class="divider"></div>
        <div id="projects-holder">
          <ul id="projects">

          </ul>
        </div>
      </div>
      <div class="col fill" id="main">
        <div>
          <strong>Github Username:</strong>
          <a id="github-username" href="" target="_blank"></a>
        </div>
        <div>
          <strong>Github Project:</strong>
          <a id="github-project-name" href="" target="_blank"></a>
        </div>
        <div>
          <strong>Commits Fixing This Vulnerability (View in <a id="commit-browser-href" target="_blank" href="#">Commit Browser</a>):</strong>
          <span id="commits"></span>
        </div>
        <div>
          <strong>CVE ID:</strong>
          <span id="cve-id"></span>
          <span id="nvd-detail-link-outer" style="display: none">
            (<a id="nvd-detail-link" target="_blank" href="">NVD Detail</a>)
          </span>
        </div>
        <div>
          <strong>CodeQL Generated Alerts (<span id="num-alerts"></span>):</strong>
          <div id="alerts">

          </div>
        </div>
        <div id="temp"></div>
      </div>
    </div>
    <script>
      const OUTPUT_DIR = "outputs"

      var codeql_advisory_cves_mapped_w_commits = [];
      var all_db_names = [];
      var all_method_info = [];
      var all_cve_tags = {};
      var globalSelectedCVEId = "";
      var globalDBName = "";

      function escapeCode(code) {
        return code
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function loadCodeQLAdvisoryCVEsMappedWCommits(data) {
        const searchParams = new URLSearchParams(window.location.search);
        if (searchParams.has("cwe")) {
          let cwe_id = searchParams.get("cwe");
          $("#cwe-filter").val(cwe_id);
          codeql_advisory_cves_mapped_w_commits = data.filter((row) => {
            if (!row["cwe"]) {
              return false;
            } else {
              return row["cwe"].split(";").indexOf(`CWE-${cwe_id}`) >= 0;
            }
          });
        } else {
          codeql_advisory_cves_mapped_w_commits = data;
        }

        for (let row_id in codeql_advisory_cves_mapped_w_commits) {
          let row = codeql_advisory_cves_mapped_w_commits[row_id];
          if (!row["commits"] || row["commits"] === "" || row["cwe"] === "" || row["cve"] === "") {
            continue;
          }
          let commits = row["commits"].split(";");
          let project = commits[0].split("/")[4];
          let cwe_ids = row["cwe"].split(";").map((id) => `<span class="cwe-id">${id}</span>`).join("");
          $("#projects").append(`
<li id="project-${row["cve"]}" onclick="clickProject('${row["cve"]}')">
  <span class="cve-id">${row["cve"]}</span>
  <span class="project">${project}</span>
  ${cwe_ids}
</li>`);
        }

        if (searchParams.has("cve")) {
          let cve_id = searchParams.get("cve");
          clickProject(cve_id);
        }
      }

      function getFileNameLineNumFromLoc(loc) {
        let uri = loc["location"]["physicalLocation"]["artifactLocation"]["uri"];
        let lineNum = loc["location"]["physicalLocation"]["region"]["startLine"];
        let baseURIParts = uri.split("/");
        let fileNameWExt = baseURIParts[baseURIParts.length - 1];
        let fileName = fileNameWExt.substring(0, fileNameWExt.indexOf(".java"));
        return `${fileName}:${lineNum}`;
      }

      function getGithubLocationURL(cveRow, loc) {
        // https://github.com/perwendel/spark/blob/2.5.1/src/main/java/spark/resource/ClassPathResource.java#L51-L55
        let cve_id = cveRow["cve"];
        let repoURL = cveRow["repository_url"];
        let dbNameSplit = globalDBName.split("_");
        let tag = all_cve_tags[cve_id];
        let relativeFileDir = loc["location"]["physicalLocation"]["artifactLocation"]["uri"];
        let lineNum = loc["location"]["physicalLocation"]["region"]["startLine"];
        return `${repoURL}/blob/${tag}/${relativeFileDir}#L${lineNum}`;
      }

      function getLocFileLevelLabel(cve_id, loc) {
        let uri = loc["location"]["physicalLocation"]["artifactLocation"]["uri"];
        return all_method_info[cve_id]["file_level"].indexOf(uri) >= 0;
      }

      function getEnclosingItem(uri, lineNum, itemLocs) {
        let item = null;
        let maxItemStartLine = null;
        for (let i = 0; i < itemLocs.length; i++) {
          let currItemLoc = itemLocs[i];
          let currItemFile = currItemLoc["file"];
          let currItemStartLine = parseInt(currItemLoc["start_line"]);
          let currItemEndLine = parseInt(currItemLoc["end_line"]);
          if (currItemFile == uri && currItemStartLine <= lineNum + 1 && currItemEndLine >= lineNum - 1) {
            if (!item || currItemStartLine > maxItemStartLine) {
              item = currItemLoc["name"];
              maxItemStartLine = currItemStartLine;
            }
          }
        }
        return item;
      }

      function getLocMethodLevelLabel(cve_id, loc, class_locs, func_locs) {
        let uri = loc["location"]["physicalLocation"]["artifactLocation"]["uri"];
        let lineNum = loc["location"]["physicalLocation"]["region"]["startLine"];

        let func = getEnclosingItem(uri, lineNum, func_locs);
        if (!func) { return false; }

        let clazz = getEnclosingItem(uri, lineNum, class_locs);
        if (!clazz) { return false; }

        let location = `${uri}:${clazz}:${func}`;
        return all_method_info[cve_id]["method_level"].indexOf(location) >= 0;
      }

      function getCodeFlowFileLevelLabel(cve_id, codeFlow) {
        return codeFlow["threadFlows"][0]["locations"].map((loc) => {
          return getLocFileLevelLabel(cve_id, loc);
        });
      }

      function getCodeFlowMethodLevelLabel(cve_id, codeFlow, class_locs, func_locs) {
        return codeFlow["threadFlows"][0]["locations"].map((loc) => {
          return getLocMethodLevelLabel(cve_id, loc, class_locs, func_locs);
        });
      }

      function codeFlowLocationToString(k, cveRow, loc, numLocs, isFileLevelMatch, isMethodLevelMatch) {
        let isFirst = k == 0 ? " first" : "";
        let isLast = k == numLocs - 1 ? " last" : "";
        let locMessage = escapeCode(loc["location"]["message"]["text"]);
        let locString = getFileNameLineNumFromLoc(loc);
        let locURL = getGithubLocationURL(cveRow, loc);
        let goldLabel = isMethodLevelMatch ? "🥇" : "";
        let silverLabel = isFileLevelMatch ? "🥈" : "";
        return `
<li class="code-flow-item row ${isFirst} ${isLast}">
  <span class="col medal">${goldLabel}${silverLabel}</span>
  <code class="col fill">${locMessage}</code>
  <a class="col" href="${locURL}" target="_blank">[${locString}]</a>
</li>`;
      }

      function codeFlowToString(i, j, cveRow, codeFlow, class_locs, func_locs) {
        let fileLevelLabels = getCodeFlowFileLevelLabel(cveRow["cve"], codeFlow);
        let methodLevelLabels = getCodeFlowMethodLevelLabel(cveRow["cve"], codeFlow, class_locs, func_locs);

        let sourceLocationURL = getGithubLocationURL(cveRow, codeFlow["threadFlows"][0]["locations"][0]);
        let sourceLocation = getFileNameLineNumFromLoc(codeFlow["threadFlows"][0]["locations"][0]);
        let sourceSnippet = "";

        let numIntermediateSteps = codeFlow["threadFlows"][0]["locations"].length;
        let codeFlowItems = codeFlow["threadFlows"][0]["locations"].map((loc, k) => {
          let isFileLevelMatch = fileLevelLabels[k];
          let isMethodLevelMatch = methodLevelLabels[k];
          return codeFlowLocationToString(k, cveRow, loc, numIntermediateSteps, isFileLevelMatch, isMethodLevelMatch);
        }).join("");

        let sinkLocationURL = getGithubLocationURL(cveRow, codeFlow["threadFlows"][0]["locations"][numIntermediateSteps - 1]);
        let sinkLocation = getFileNameLineNumFromLoc(codeFlow["threadFlows"][0]["locations"][numIntermediateSteps - 1]);
        let sinkSnippet = "";

        let goldLabel = methodLevelLabels.some(v => v) ? "🥇" : "";
        let silverLabel = fileLevelLabels.some(v => v) ? "🥈" : "";

        return `
<div class="code-flow" id="code-flow-${i}-${j}">
  <div class="row">
    <strong class="col fill">💡 Code Flow #<span>${j + 1}</span></strong>
    <span>${goldLabel}${silverLabel}</span>
  </div>
  <div class="code-flow-source-sink">
    <div class="row">
      <span class="col fill">Source Code Snippet:</span>
      <a class="col" href="${sourceLocationURL}" target="_blank">[${sourceLocation}]</a>
    </div>
    <pre>${sourceSnippet}</pre>
  </div>
  <div class="divider"></div>
  <strong>🚧 Intermediate Steps (<span>${numIntermediateSteps}</span>):</strong>
  <ul class="code-flow-items">${codeFlowItems}</ul>
  <div class="divider"></div>
  <div class="code-flow-source-sink">
    <div class="row">
      <span class="col fill">Sink Code Snippet:</span>
      <a class="col" href="${sinkLocationURL}" target="_blank">[${sinkLocation}]</a>
    </div>
    <pre>${sinkSnippet}</pre>
  </div>
</div>`;
      }

      function outputSarifResultToString(i, cveRow, result, class_locs, func_locs) {
        let numCodeFlows = 0;
        let codeFlowsHtml = "";
        if (!result["codeFlows"]) {
          numCodeFlows = 0;
        } else {
          numCodeFlows = result["codeFlows"].length;
          codeFlowsHtml = result["codeFlows"].map((codeFlow, j) => {
            return codeFlowToString(i, j, cveRow, codeFlow, class_locs, func_locs);
          }).join("");
        }

        return `
<div class="alert">
  <strong>⚠️ Alert #<span>${i + 1}</span></strong>
  <span>(#Code Flows: ${numCodeFlows})</span>
  <button onclick="labelAlert(${i}, false)">❌ Label as FP</button>
  <button onclick="labelAlert(${i}, true)">✅ Label as TP</button>
  <div class="code-flows">
    ${codeFlowsHtml}
  </div>
</div>`;
      }

      function loadOutputSarif(row, cve_id, db_name, class_locs, func_locs) {
        globalSelectedCVEId = cve_id;
        globalDBName = db_name;

        $("#alerts").html("");

        let query = "";
        if (row["cwe"].split(";").indexOf("CWE-22") >= 0) {
          query = "cwe-022wCodeQL";
        } else if (row["cwe"].split(";").indexOf("CWE-94") >= 0) {
          query = "cwe-094wCodeQL";
        } else if (row["cwe"].split(";").indexOf("CWE-78") >= 0) {
          query = "cwe-078wCodeQL";
        } else if (row["cwe"].split(";").indexOf("CWE-79") >= 0) {
          query = "cwe-079wCodeQL";
        } else {
          $("#alerts").html("No Alerts Generated");
          return;
        }

        $.ajax({
          // codeql/saikat-outputs/perwendel__spark_CVE-2016-9177_2.5.1/cwe-022wLLM.ql_gpt-4/results.sarif
          url: `/codeql/${OUTPUT_DIR}/${db_name}/${query}/results.sarif`,
          type: "GET",
          dataType: "json",
          success: (data) => {
            $("#num-alerts").text(data["runs"][0]["results"].length);
            let htmlStr = data["runs"][0]["results"].map((result, i) => {
              return outputSarifResultToString(i, row, result, class_locs, func_locs);
            }).join("");
            $("#alerts").append(htmlStr);
          }
        })
      }

      function loadClassLocations(cve_id, db_name, callback) {
        $.ajax({
          url: `/codeql/outputs/${db_name}/fetch_class_locs.ql/results.csv`,
          type: "GET",
          success: (csv_content) => {
            let parsed_result = Papa.parse(csv_content, { header: true });
            let data = parsed_result.data;
            callback(data)
          }
        })
      }

      function loadFuncLocations(cve_id, db_name, callback) {
        $.ajax({
          url: `/codeql/outputs/${db_name}/fetch_func_locs.ql/results.csv`,
          type: "GET",
          success: (csv_content) => {
            let parsed_result = Papa.parse(csv_content, { header: true });
            let data = parsed_result.data;
            callback(data)
          }
        })
      }

      function clickProject(cve_id) {
        var currentUrl = window.location.href;
        var url = new URL(currentUrl);
        url.searchParams.set("cve", cve_id);
        window.history.pushState(null, document.title, url.href);

        $(`#project-${cve_id}`).addClass("active").siblings().removeClass("active");

        $("#cve-id").text(cve_id);
        let row = codeql_advisory_cves_mapped_w_commits.filter((row) => row["cve"] == cve_id)[0];

        let commits = row["commits"].split(";");
        $("#cve-id").text(row["cve"]);

        let github_username = commits[0].split("/")[3];
        $("#github-username").attr("href", `https://github.com/${github_username}`);
        $("#github-username").text(github_username);

        let github_project = commits[0].split("/")[4];
        $("#github-project-name").attr("href", `https://github.com/${github_username}/${github_project}`);
        $("#github-project-name").text(github_project);

        $("#nvd-detail-link-outer").attr("style", "");
        $("#nvd-detail-link").attr("href", `https://nvd.nist.gov/vuln/detail/${row["cve"]}`);

        $("#commit-browser-href").attr("href", `/codeql/visualizer/commit_browser.html?cve=${cve_id}`);

        $("#commits").html("");
        commits.forEach((commit_link) => {
          let commit_id = commit_link.split("/")[6];
          $("#commits").append(`<a class="commit" target="_blank" href="${commit_link}">${commit_id.substring(0, 12)}</a>`);
        });

        let buggy_version = row["buggy"];
        let dbNames = all_db_names.filter((name) => name.indexOf(cve_id) >= 0 && name.indexOf(buggy_version) == name.length - buggy_version.length);
        if (dbNames.length == 0) {
          $("#num-alerts").text(0);
          $("#alerts").html("No DB Found");
        } else {
          let dbName = dbNames[0];
          loadClassLocations(cve_id, dbName, (classLocs) => {
            loadFuncLocations(cve_id, dbName, (funcLocs) => {
              loadOutputSarif(row, cve_id, dbName, classLocs, funcLocs);
            })
          })
        }
      }

      function loadAllDBNames(callback) {
        $.ajax({
          url: `/codeql/${OUTPUT_DIR}/`, // CHANGE THIS!
          type: "GET",
          success: (data) => {
            const regexp = /<a href="(\S+)\/">/g;
            const results = [...data.matchAll(regexp)].map((d) => d[1]);
            all_db_names = results;
            callback();
          },
        });
      }

      function loadAllMethodInfo(callback) {
        $.ajax({
          url: "/all_method_info.csv",
          type: "GET",
          success: (csv_content) => {
            let parsed_result = Papa.parse(csv_content, { header: true });
            all_method_info = {}
            for (let i = 0; i < parsed_result.data.length; i++) {
              let row = parsed_result.data[i];
              if (!all_method_info[row["cve"]]) {
                all_method_info[row["cve"]] = {
                  "file_level": [],
                  "method_level": [],
                }
              }

              let fileLevelLocation = `${row["file"]}`
              all_method_info[row["cve"]]["file_level"].push(fileLevelLocation);

              let methodLevelLocation = `${row["file"]}:${row["class"]}:${row["method"]}`
              all_method_info[row["cve"]]["method_level"].push(methodLevelLocation);
            }
            callback()
          },
        });
      }

      function loadCVEGithubTag(callback) {
        $.ajax({
          url: "/all_project_tags.csv",
          type: "GET",
          success: (csv_content) => {
            let parsed_result = Papa.parse(csv_content, { header: true });
            let mapping = {};
            for (let i = 0; i < parsed_result.data.length; i++) {
              let row = parsed_result.data[i];
              mapping[row["cve"]] = row["tag"];
            }
            all_cve_tags = mapping;
            callback();
          },
        });
      }

      function loadAdvisoryCVEs() {
        $.ajax({
          url: "/codeql/codeql_advisory_cves_mapped_w_commits.csv",
          type: "GET",
          success: (csv_content) => {
            let parsed_result = Papa.parse(csv_content, { header: true });
            let data = parsed_result.data;
            loadCodeQLAdvisoryCVEsMappedWCommits(data);
          },
        });
      }

      loadAllDBNames(() => {
        loadAllMethodInfo(() => {
          loadCVEGithubTag(() => {
            loadAdvisoryCVEs()
          });
        });
      });
    </script>
  </body>
</html>
