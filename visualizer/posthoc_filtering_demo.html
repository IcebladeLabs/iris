<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="/codeql/visualizer/basic.css" />
    <link rel="stylesheet" href="/codeql/visualizer/alert_viewer.css" />
  </head>
  <body>
    <div class="row absolute full-height full-width">
      <div class="col" id="sidebar">
        <div style="margin-bottom: 10px">
          CWE: <form style="display: inline-block"><input id="cwe-filter" name="cwe" placeholder="CWE" /><button action="submit">Submit</button></form>
        </div>
        <div class="divider"></div>
        <div id="projects-holder">
          <ul id="projects">

          </ul>
        </div>
      </div>
      <div class="col fill" id="main">
        <div style="width: 100%; max-width: 1080px; margin: 0 auto">
          <div>
            <strong>CVE ID:</strong>
            <span id="cve-id"></span>
            <span id="nvd-detail-link-outer" style="display: none">
              (<a id="nvd-detail-link" target="_blank" href="">NVD Detail</a>)
            </span>
          </div>
          <div>
            <strong>Github:</strong>
            <a id="github-username" href="" target="_blank"></a>
            &nbsp; / &nbsp;
            <a id="github-project-name" href="" target="_blank"></a>
            &nbsp; / &nbsp;
            <a id="github-project-tag" href="" target="_blank"></a>
          </div>
          <div>
            <strong>NVD Vulnerability Description:</strong>
            <div id="nvd-vulnerability-description"></div>
          </div>
          <div>
            <strong>Commits Fixing This Vulnerability (View in <a id="commit-browser-href" target="_blank" href="#">Commit Browser</a>):</strong>
            <span id="commits"></span>
          </div>
          <div hidden="hidden">
            <strong>Fix Locations:</strong>
            <ul id="fix-locations"></ul>
          </div>
          <div>
            <strong>Alerts Generated by CodeQL (View in <a id="codeql-results-href" target="_blank" href="#">CodeQL Result Viewer</a>)</strong>
          </div>
          <div>
            <strong>Quick Access to GPT Label:</strong>
            <span id="gpt-labels"></span>
          </div>
          <div>
            <strong>Alerts Generated by Our Method (<span id="num-alerts"></span>):</strong>
            <div id="alerts">

            </div>
          </div>
          <div id="temp"></div>
        </div>
      </div>
    </div>
    <div class="float-button" style="right: 280px; width: 110px" onclick="saveResult()">
      <span class="text">Download</span> <span class="emoji">‚¨áÔ∏è</span>
    </div>
    <div class="float-button" style="right: 182px; width: 75px" onclick="saveResult()">
      <span class="text">Save</span> <span class="emoji">üíæ</span>
    </div>
    <div class="float-button" onclick="$('#main').animate({ scrollTop: 0 }, 'slow')">
      <span class="text">Back To Top</span> <span class="emoji">‚òùÔ∏è</span>
    </div>
    <script src="alert_viewer.js"></script>
    <script>
      const OUTPUT_DIR = "saikat-outputs";

      const SIDEBAR_OUTPUT_DIR = "outputs";

      const WORKING_CWE_IDS = {
        "CWE-22": "posthoc-filter/cwe-022wLLM",
        "CWE-78": "posthoc-filter/cwe-078wLLM",
        "CWE-79": "posthoc-filter/cwe-079wLLM",
        "CWE-94": "posthoc-filter/cwe-094wLLM",
      }

      function codeFlowLocationToString(k, cveRow, loc, numLocs, isFileLevelMatch, isMethodLevelMatch) {
        let isFirst = k == 0 ? " first" : "";
        let isLast = k == numLocs - 1 ? " last" : "";
        let locMessage = escapeCode(loc["location"]["message"]["text"]);
        let locString = getFileNameLineNumFromLoc(loc);
        let locURL = getGithubLocationURL(cveRow, loc);
        return `
<li class="code-flow-item row ${isFirst} ${isLast}">
  <span class="col medal"></span>
  <code class="col fill">${locMessage}</code>
  <a class="col" href="${locURL}" target="_blank">[${locString}]</a>
</li>`;
      }

      function codeFlowToString(i, j, cveRow, codeFlow, class_locs, func_locs, posthoc_filter_result) {
        let fileLevelLabels = getCodeFlowFileLevelLabel(cveRow["cve"], codeFlow);
        let methodLevelLabels = getCodeFlowMethodLevelLabel(cveRow["cve"], codeFlow, class_locs, func_locs);

        let sourceLocationURL = getGithubLocationURL(cveRow, codeFlow["threadFlows"][0]["locations"][0]);
        let sourceLocation = getFileNameLineNumFromLoc(codeFlow["threadFlows"][0]["locations"][0]);
        let sourceSnippet = "";

        let numIntermediateSteps = codeFlow["threadFlows"][0]["locations"].length;
        let codeFlowItems = codeFlow["threadFlows"][0]["locations"].map((loc, k) => {
          let isFileLevelMatch = fileLevelLabels[k];
          let isMethodLevelMatch = methodLevelLabels[k];
          return codeFlowLocationToString(k, cveRow, loc, numIntermediateSteps, isFileLevelMatch, isMethodLevelMatch, true);
        }).join("");

        let sinkLocationURL = getGithubLocationURL(cveRow, codeFlow["threadFlows"][0]["locations"][numIntermediateSteps - 1]);
        let sinkLocation = getFileNameLineNumFromLoc(codeFlow["threadFlows"][0]["locations"][numIntermediateSteps - 1]);
        let sinkSnippet = "";

        let gpt_result = "";
        let prompt = "";
        if (posthoc_filter_result) {
          let relevant_posthoc_filter_results = posthoc_filter_result["individual_path_result"].filter((e) => {
            return e["result_id"] == i && e["path_id"] == j;
          });
          if (relevant_posthoc_filter_results.length > 0) {
            let this_result = relevant_posthoc_filter_results[0];
            let gpt_assessment = this_result["result"]["result"] ? "‚úÖ True Positive" : "‚ùå False Positive";
            let gpt_explanation = this_result["result"]["explanation"];
            let is_cached = this_result["using_cache"] ? " (cached)" : "";
            let confidence = this_result["result"]["confidence"] ? `<div><strong>GPT Confidence: ${this_result["result"]["confidence"]}</strong></div>` : "";
            gpt_result = `<div><div><strong>GPT Assessment: </strong><strong>${gpt_assessment} ${is_cached}</strong></div>${confidence}<p style="margin-top: 0; line-height: 12px;"><strong>GPT Explanation: </strong><span>${gpt_explanation}</span></p></div>`;
            if ($(`#gpt-label-${i}`).length == 0 && this_result["result"]["result"]) {
              $("#gpt-labels").append(`<a class="label" id="gpt-label-${i}" href="#alert-${i}">ü§ñ Alert#${i + 1}</a>`);
            }
            prompt = `<div class="divider"></div><div class="prompt"><strong>User Prompt: </strong> <pre>${escapeCode(this_result["prompt"])}</pre></div>`;
          } else {
            gpt_result = `<div><strong>GPT Assessment: </strong><strong>Not found</strong></div>`;
          }
          gpt_result = `<div class="divider" style="margin-top: 10px"></div>${gpt_result}<div class="divider"></div>`;
        }

        return `
<div class="code-flow" id="code-flow-${i}-${j}">
  <div class="row">
    <strong class="col fill">üí° Code Flow #<span>${j + 1}</span></strong>
    <div class="col">
      Is FP? <input type="checkbox" class="code-flow-fp-checkbox" id="code-flow-fp-checkbox-${i}-${j}" data-alert-index="${i}" data-code-flow-index="${j}" />
      Is TP? <input type="checkbox" class="code-flow-tp-checkbox" id="code-flow-tp-checkbox-${i}-${j}" data-alert-index="${i}" data-code-flow-index="${j}" />
    </div>
  </div>
  <div class="center">
    <button onclick="labelSimilarSource(${i}, ${j}, false)">‚ùå Label same-src flows as FP</button>
    &nbsp; | &nbsp;
    <button onclick="labelSimilarSource(${i}, ${j}, true)">‚úÖ Label same-src flows as TP</button>
  </div>
  ${gpt_result}
  <div class="code-flow-source-sink">
    <div class="row">
      <span class="col fill">Source Code Snippet:</span>
      <a class="col" href="${sourceLocationURL}" target="_blank">[${sourceLocation}]</a>
    </div>
    <pre>${sourceSnippet}</pre>
  </div>
  <div class="divider"></div>
  <strong>üöß Intermediate Steps (<span>${numIntermediateSteps}</span>):</strong>
  <ul class="code-flow-items">${codeFlowItems}</ul>
  <div class="divider"></div>
  <div class="code-flow-source-sink">
    <div class="row">
      <span class="col fill">Sink Code Snippet:</span>
      <a class="col" href="${sinkLocationURL}" target="_blank">[${sinkLocation}]</a>
    </div>
    <pre>${sinkSnippet}</pre>
  </div>
  ${prompt}
</div>`;
      }

      function outputSarifResultToString(i, cveRow, result, class_locs, func_locs, posthoc_filter_result) {
        let numCodeFlows = 0;
        let codeFlowsHtml = "";
        if (!result["codeFlows"]) {
          if (result["relatedLocations"]) {
            numCodeFlows = 1;
            let codeFlow = {
              "threadFlows": [{
                "locations": result["relatedLocations"].map((item) => {
                  return { "location": item };
                }),
              }]
            };
            codeFlowsHtml = codeFlowToString(i, 0, cveRow, codeFlow, class_locs, func_locs);
          } else {
            numCodeFlows = 0;
          }
        } else {
          numCodeFlows = result["codeFlows"].length;
          codeFlowsHtml = result["codeFlows"].map((codeFlow, j) => {
            return codeFlowToString(i, j, cveRow, codeFlow, class_locs, func_locs, posthoc_filter_result);
          }).join("");
        }

        return `
<div class="alert" id="alert-${i}">
  <div class="row">
    <div class="col fill">
      <strong>‚ö†Ô∏è Alert #<span>${i + 1}</span></strong>
      <span>(#Code Flows: ${numCodeFlows})</span>
    </div>
    <div>
      <button onclick="removeAlertLabel(${i})">üî≤ Remove Label</button>
      <button onclick="labelAlert(${i}, false)">‚ùå Label as FP</button>
      <button onclick="labelAlert(${i}, true)">‚úÖ Label as TP</button>
    </div>
  </div>
  <div class="code-flows">
    ${codeFlowsHtml}
  </div>
</div>`;
      }

      function loadPosthocFilterResult(cve_id, db_name, query, callback) {
        if (query && query != "") {
          $.ajax({
            url: `/codeql/outputs/${db_name}/posthoc-filter/${query}/results.json`,
            type: "GET",
            dataType: "json",
            success: (data) => callback(data),
            error: (_) => callback(null),
          })
        } else {
          callback(null);
        }
      }

      function render(row, cve_id, db_name, class_locs, func_locs) {
        globalSelectedCVEId = cve_id;
        globalDBName = db_name;

        $("#alerts").html("");

        let query = "";
        let posthoc_query = "";
        let output_dir = "";
        if (row["cwe"].split(";").indexOf("CWE-22") >= 0) {
          query = "cwe-022wLLM.ql_gpt-4";
          posthoc_query = "cwe-022wLLM";
          output_dir = "saikat-outputs";
        } else if (row["cwe"].split(";").indexOf("CWE-78") >= 0) {
          query = "CommandInjectionRuntimeExecwLLM.ql_gpt-4";
          posthoc_query = "cwe-078wLLM";
          output_dir = "saikat-outputs";
        } else if (row["cwe"].split(";").indexOf("CWE-79") >= 0) {
          query = "XSS.ql_gpt-4";
          posthoc_query = "cwe-079wLLM";
          output_dir = "saikat-outputs";
        } else if (row["cwe"].split(";").indexOf("CWE-94") >= 0) {
          query = "SpelInjection.ql_gpt-4";
          posthoc_query = "cwe-094wLLM";
          output_dir = "saikat-outputs";
        } else {
          $("#alerts").html("No Alerts Generated");
          return;
        }

        loadPosthocFilterResult(cve_id, db_name, posthoc_query, (posthoc_filter_result) => {
          loadOutputSarif(output_dir, db_name, query, (output_sarif) => {
            $("#num-alerts").text(output_sarif["runs"][0]["results"].length);
            let htmlStr = output_sarif["runs"][0]["results"].map((result, i) => {
              return outputSarifResultToString(i, row, result, class_locs, func_locs, posthoc_filter_result);
            }).join("");
            $("#alerts").append(htmlStr);

            loadManualLabel(cve_id, db_name, (data) => {
              if (data) {
                for (let i = 0; i < data.length; i++) {
                  let item = data[i];
                  let alertId = item["alert_id"];
                  let codeFlowId = item["code_flow_id"];
                  let isTruePos = item["is_true_pos"];
                  let isFalsePos = item["is_false_pos"];
                  $(`#code-flow-tp-checkbox-${alertId}-${codeFlowId}`).prop("checked", isTruePos);
                  $(`#code-flow-fp-checkbox-${alertId}-${codeFlowId}`).prop("checked", isFalsePos);
                }
              }
            })
          });
        });
      }

      function clickProject(cve_id) {
        var currentUrl = window.location.href;
        var url = new URL(currentUrl);
        url.searchParams.set("cve", cve_id);
        window.history.pushState(null, document.title, url.href);

        $(`#project-${cve_id}`).addClass("active").siblings().removeClass("active");

        $("#cve-id").text(cve_id);
        let row = codeql_advisory_cves_mapped_w_commits.filter((row) => row["cve"] == cve_id)[0];

        let commits = row["commits"].split(";");
        $("#cve-id").text(row["cve"]);

        let github_username = commits[0].split("/")[3];
        $("#github-username").attr("href", `https://github.com/${github_username}`);
        $("#github-username").text(github_username);

        let github_project = commits[0].split("/")[4];
        $("#github-project-name").attr("href", `https://github.com/${github_username}/${github_project}`);
        $("#github-project-name").text(github_project);

        let tag = all_cve_tags[cve_id];
        $("#github-project-tag").attr("href", `https://github.com/${github_username}/${github_project}/tree/${tag}`);
        $("#github-project-tag").text(tag);

        $("#nvd-detail-link-outer").attr("style", "");
        $("#nvd-detail-link").attr("href", `https://nvd.nist.gov/vuln/detail/${row["cve"]}`);
        $("#nvd-vulnerability-description").html("");
        queryNVDDescription(row["cve"], (data) => {
          $("#nvd-vulnerability-description").html(data);
        });

        $("#commit-browser-href").attr("href", `/codeql/visualizer/commit_browser.html?cve=${cve_id}`);
        $("#codeql-results-href").attr("href", `/codeql/visualizer/view_codeql_result.html?cve=${cve_id}`);

        $("#gpt-labels").html("");
        $("#golden-labels").html("");
        $("#silver-labels").html("");

        $("#commits").html("");
        commits.forEach((commit_link) => {
          let commit_id = commit_link.split("/")[6];
          $("#commits").append(`<a class="commit" target="_blank" href="${commit_link}">${commit_id.substring(0, 12)}</a>`);
        });

        if (all_method_info[row["cve"]]) {
          $("#fix-locations").html(all_method_info[row["cve"]]["locations"].filter((loc) => {
            let parts = loc["file"].split("/");
            for (let i = 0; i < Math.min(3, parts.length); i++) {
              if (parts[i] == "test") {
                return false;
              }
            }
            return true;
          }).map((loc) => {
            return `<li><a target="_blank" href="https://github.com/${github_username}/${github_project}/blob/${loc["commit"]}/${loc["file"]}">${loc["file"]}:${loc["class"]}:${loc["method"]}</a></li>`;
          }).join(""));
        } else {
          $("#fix-locations").html("No Commit Information")
        }

        let buggy_version = row["buggy"];
        let dbNames = all_db_names.filter((name) => name.indexOf(cve_id) >= 0 && name.indexOf(buggy_version) == name.length - buggy_version.length);
        if (dbNames.length == 0) {
          $("#num-alerts").text(0);
          $("#alerts").html("No DB Found");
        } else {
          let dbName = dbNames[0];
          loadClassLocations(cve_id, dbName, (classLocs) => {
            loadFuncLocations(cve_id, dbName, (funcLocs) => {
              render(row, cve_id, dbName, classLocs, funcLocs);
            })
          })
        }
      }

      loadAllDBNames(() => {
        loadAllMethodInfo(() => {
          loadCVEGithubTag(() => {
            loadAdvisoryCVEs()
          });
        });
      });
    </script>
  </body>
</html>
